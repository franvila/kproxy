#
# Copyright Kroxylicious Authors.
#
# Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0
#

# Multi-stage build for OpenMessaging Benchmark (OMB).
# The published openmessaging/openmessaging-benchmark:latest image ships
# Kafka client 1.0.0 on Java 8.  This Containerfile builds from the
# current upstream source (Kafka 3.6.1, JDK 21).

# Upstream OMB has no tags or releases â€” pin to a known-good commit on master.
ARG OMB_COMMIT=85599891321cafa2fb7065a63f009b4bb5374288

# ---------- Stage 1: build ----------
FROM registry.access.redhat.com/ubi9/openjdk-21:1.24-2.1771324989@sha256:646e61a0b9d03033b1caec510412e4bb1d75e9b33b01f48d693ffe3992459910 AS builder
USER root

ARG OMB_COMMIT
RUN microdnf --setopt=install_weak_deps=0 --setopt=tsflags=nodocs install -y git && \
    microdnf clean all

RUN git clone https://github.com/openmessaging/benchmark.git /build && \
    cd /build && git checkout ${OMB_COMMIT}

WORKDIR /build
RUN mvn clean package -DskipTests && \
    mkdir -p /opt/benchmark && \
    tar -xzf /build/package/target/openmessaging-benchmark-*-bin.tar.gz --strip-components=1 -C /opt/benchmark

# ---------- Stage 2: runtime ----------
FROM registry.access.redhat.com/ubi9/openjdk-21-runtime:1.24-2.1771324986@sha256:f2764fc96da28f9e1c08051b7fdf8f4282e76ba5b60637d6bbabf8a1ea45bf6e
USER root

COPY --from=builder --chown=185:0 /opt/benchmark /opt/benchmark

USER 185
WORKDIR /opt/benchmark
